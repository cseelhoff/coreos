variant: fcos
version: 1.4.0
passwd:
  users:
    - name: admin
      groups:
        - docker
        - wheel
      ssh_authorized_keys:
        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQC0JcTPNRGCgdBM97WC9x9c0fFiCGWCkK20mdVhaPoFHGchLnKbVCyZKBnekU+uOZb+SVDG+oZeOCIGH7uY/GG1a1idb/yQHrzbW+SvNofySTgs8pzU6uGxz6vvJDnzqnSTFGpvXBXRuolEipFUAXsaUFLqhahSROzA0JeX9U4mYlElz8Kix+R3FIVY5EEfJORLfSS4y65teWoaUOFLnfDN22519bWswFtlTa6yuP3rDZfePQ1vYFECzcrLgqn6G3SRUklCDo7j9UMdohP6Kon46eMA84jrH/ep6pK4EDRW7G5JpcbrosjYKCIgNEpkYlKs3ohvM4VoBRC+OON9YM7up14mq86swrP+0avb+8nNhtcRirhsdeBPEErElb3pvRNDkThQDPC9QtwwYlJ00xNyS/Xb+9BXVu2T2UZxEzV/usLHuiB5gvwDAbilT8DNivVT75I7UWDBOPoBcCW0BMkiY+OKAQb2c0k6yYSv3kSSBaTDUQX/WE+q/lvNHPpRcOZZoY56eLSiJCh3RKrOEqKAoA++AGH/8LYcXZLue28RrgGiZrWOcu3JDNQ1jKrixGHn5MDQh4LmARnQQ1w8euRJJsgqucIoj4dXbjYeFKlIQPzqI38vJKNRWgkv4Wan7V76d0nd7wji5JVKY5hfm/D/ZsvFiVK2ORMpfoVHsNJ0ow== root@fc614cbfe601 root@fc614cbfe601 root@fc614cbfe601 root@fc614cbfe601 root@fc614cbfe601 root@fc614cbfe601 root@fc614cbfe601 root@fc614cbfe601 root@fc614cbfe601 root@b13611c39020 root@b13611c39020 root@b13611c39020 root@b13611c39020 root@68e1a3b53fc4 root@68e1a3b53fc4 root@68e1a3b53fc4 root@68e1a3b53fc4 root@68e1a3b53fc4 root@68e1a3b53fc4 root@68e1a3b53fc4 root@68e1a3b53fc4 root@68e1a3b53fc4 root@68e1a3b53fc4 root@68e1a3b53fc4 root@68e1a3b53fc4 root@68e1a3b53fc4 root@68e1a3b53fc4 root@15a30bf7891e root@15a30bf7891e root@15a30bf7891e root@15a30bf7891e root@15a30bf7891e root@15a30bf7891e root@15a30bf7891e root@15a30bf7891e root@15a30bf7891e
      password_hash: $y$j9T$xP4E93jrWCP37dNfSKGJL/$EYZt/NBmSBjHu9EeaKKVXKnszK0iJsHH/XCbXqdn.9B
storage:
  files:
    - path: /usr/local/bin/docker-compose
      overwrite: true
      contents:
        source: https://github.com/docker/compose/releases/download/v2.24.2/docker-compose-linux-x86_64
        verification:
          hash: sha512-DBB485B512B885DE15FF92C24D3CA1B0F46D62BF5DBCD166FD286F545652FA673E4988CFD43A708F7ECFEA34AC92538D119C4625E7B3DBB3BB006277F76F9823
      mode: 0755

    - path: /opt/portainer/deploy-stack.sh
      mode: 0644
      contents:
        local: portainer/deploy-stack.sh

    - path: /opt/portainer/openldap-docker-compose.yml
      mode: 0644
      contents:
        local: portainer/openldap-docker-compose.yml

    - path: /opt/portainer/portainer.tar.gz
      contents:
        local: http://restore.us.177cpt.com/portainer.tar.gz

    # - path: /tmp/backups/openldap.tar.gz
    #   contents:
    #     source: http://restore.us.177cpt.com/openldap.tar.gz

    # - path: /tmp/backups/gitea.tar.gz
    #   contents:
    #     source: http://restore.us.177cpt.com/gitea.tar.gz

    # - path: /tmp/backups/nexus.tar.gz
    #   contents:
    #     source: http://restore.us.177cpt.com/nexus.tar.gz

    # - path: /tmp/backups/awx.tar.gz
    #   contents:
    #     source: http://restore.us.177cpt.com/awx.tar.gz

    # - path: /tmp/backups/traefik.tar.gz
    #   contents:
    #     source: http://restore.us.177cpt.com/traefik.tar.gz

systemd:
  units:
# add vmware-tools
    - name: open-vm-tools.service
      enabled: true
      contents: |
        [Unit]
        Description=Open VM Tools
        After=network-online.target
        Wants=network-online.target

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        TimeoutStartSec=0
        ExecStartPre=-/usr/bin/docker stop %n
        ExecStartPre=-/usr/bin/docker rm %n
        ExecStartPre=/usr/bin/docker pull immutablecode/open-vm-tools:1.0.0
        ExecStart=/usr/bin/docker run -e SYSTEMD_IGNORE_CHROOT=1 -v  /proc/:/hostproc/ -v /sys/fs/cgroup:/sys/fs/cgroup -v /run/systemd:/run/systemd --pid=host --net=host --ipc=host --uts=host --rm  --privileged --name open-vm-tools immutablecode/open-vm-tools:1.0.0
        ExecStop=/usr/bin/docker stop -t 15 %n

        [Install]
        WantedBy=multi-user.target

    # - name: restore-backups.service
    #   enabled: true
    #   contents: |
    #     [Unit]
    #     Description=Restore Backups
    #     After=network-online.target
    #     Wants=network-online.target

    #     [Service]
    #     Type=oneshot
    #     ExecStart=for file in /tmp/backups/*.tar.gz; do tar -xzf "$file" -C /; done

    #     [Install]
    #     WantedBy=multi-user.target

# add portainer service
    - name: docker.portainer.service
      enabled: true
      contents: |-
        [Unit]
        Description=Portainer Admin Container
        After=docker.service
        Requires=docker.service network.target network-online.target
        
        [Service]
        Type=oneshot
        RemainAfterExit=yes
        TimeoutStartSec=0
        ExecStartPre=-/usr/bin/docker stop %n
        ExecStartPre=-/usr/bin/docker rm %n
        ExecStartPre=/usr/bin/docker pull portainer/portainer-ce
        ExecStart=-/usr/bin/mkdir -p /var/portainer/data
        ExecStart=/usr/bin/docker run --privileged=true -d -p 9000:9000 --name %n --restart always -v /var/run/docker.sock:/var/run/docker.sock -v /var/portainer/data:/data portainer/portainer-ce:2.19.4 --admin-password '$$2y$$05$$pXroWdzryH8Ilis/01Ia8eZNqkD1nW.inPuUE3Uy9GK.DoGqH.Q0C'
        ExecStop=/usr/bin/docker stop -t 15 %n
        
        [Install]
        WantedBy=multi-user.target
    - name: docker.openldap.service
      enabled: true
      contents: |-
        [Unit]
        Description=OpenLDAP Container
        After=docker.portainer.service
        Requires=docker.service docker.portainer.service network.target network-online.target
        
        [Service]
        Type=oneshot
        RemainAfterExit=yes
        TimeoutStartSec=0
        ExecStart=/usr/bin/sh /opt/portainer/deploy-stack.sh openldap /opt/portainer/openldap-docker-compose.yml
        
        [Install]
        WantedBy=multi-user.target
